---
title: "Analyse de séries temporelles avec R - Exercices"
author: "Alexis Gabadinho"
date: "2023-10-05"

output:
  beamer_presentation:
    theme: "AnnArbor"
    colortheme: "dolphin"
    fonttheme: "structurebold"
    number_sections: true
    toc: true
    df_print: tibble
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE)
summarytools::st_options(plain.ascii = FALSE, style = "rmarkdown")

def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  paste0("\n \\", "tiny","\n\n", x, "\n\n \\normalsize")
})
```


## Importation de fichiers csv - Données PIB

- Le fichier `pib_fr.csv` contient la série temporelle du PIB et de ses composants depuis 1949 (valeurs aux prix courants - Source: INSEE) :
- On importe les données à partir du fichier csv avec la fonction `read_csv2()`
- A noter: dans le fichier `pib_fr.csv`, le séparateur de champs est un point virgule et le point décimal est représenté par une virgule (format européen)

```{r pib_read_csv}
library(tidyverse)
pib <- read_csv2("../data/pib_fr.csv")
```

## Aperçu du jeu de données

- Les données sont stockées dans un objet de classe `tibble`
```{r}
class(pib)
```

- A noter: la colonne `PERIODE` est de type `CHR` (charactère), il faut la transformer pour créer un index temporel


```{r pib_head, echo=TRUE}
head(pib)
```

## Fichier `pib`: Liste des séries 

- Liste des séries:
  - PIB = Produit intérieur brut
  - P7 = Importations
  - P3M = Dépenses de consommation des ménages
  - P3P = Dépenses de consommation des ISBLSM
  - P31G = Dépenses de consommation des APU (individual.)
  - P32G = Dépenses de consommation des APU (collectives)
  - P3 = Dépenses de consommation totale
  - P51S = FBCF (formation brute de capital fixe) des entreprises non financières
  - P51B = FBCF (formation brute de capital fixe) des entreprises financières
  - P51G = FBCF (formation brute de capital fixe) des APU
  - P51G = FBCF (formation brute de capital fixe) des ménages
  - P51P = FBCF (formation brute de capital fixe) des ISBLSM
  - P51 = FBCF (formation brute de capital fixe) des total
  - P54 = Variations de stock
  - P6 = Exportations

## Extraction de la date

- On extrait l'information sur l'année et le trimestre à partir de la colonne `PERIODE`

```{r pib_mutate, echo=TRUE, indent="    "}
pib <- pib %>% mutate(ANNEE=substring(PERIODE, 1, 4), TRIMESTRE=substring(PERIODE, 6, 7))
pib %>% select("PIB", "ANNEE", "TRIMESTRE")
```

## Pairplot

- On peut visualiser la distribution et la corrélation entre variables avec la fonction `ggpairs` de la librairie `GGally`
```{r GGally, echo=FALSE}
library(GGally)
```
- On sélectionne ici un sous-ensemble de variables pour limiter la taille du graphique

```{r, eval=FALSE}
g <- pib %>% select(1:7) %>% 
  ggpairs(upper = list(continuous = wrap("cor", size = 4)),
          lower = list(continuous = wrap("points", colour="blue", alpha=0.3, size=0.5)))
```

## Transformation des données `pib` en objet `ts`

- On peut transformer un objet `data.frame` en objet `ts` ou `mts` avec la fonction `ts()`
- A noter: pour les données `pib`, frequency=4 (trimestres)

```{r pib_ts, echo=TRUE}
pib_ts <- ts(pib[,2:(ncol(pib)-2)], frequency=4,start=c(1949,1))
window(pib_ts, start=2022, end=2023)
```


## Création d'un objet `tsibble` - Données `pib`

- On créé un objet `tsibble` avec la fonction `as_tsibble()` 
- Ici on créé une colonne de type `yearquarter` contenant le trimestre qui va être utilisée comme index
- On convertit les données au format long avec la fonction `pivot_longer()` 

```{r pib_tsibble, echo=TRUE, message=FALSE}
library(tsibble)

pib_tbl_long <- pib %>% 
  mutate(ANNEE=as.numeric(ANNEE), TRIMESTRE=as.numeric(TRIMESTRE)) %>%   
  mutate(index=make_yearquarter(year=ANNEE, quarter=TRIMESTRE)) %>%
  select(-ANNEE, -TRIMESTRE, -PERIODE) %>% 
 pivot_longer(cols=c(PIB, P7, P3M, P3P, P31G, P32G, P3, P51S, P51B, P51G, P51M, P51P, P51, P54, P6), names_to="key")
pib_tbl_long
```


## Création d'un objet `tsibble` - Données `pib`

```{r}
pib_tsbl <- pib_tbl_long %>% as_tsibble(index=index, key=key)
pib_tsbl %>% filter(index > yearquarter("2022 Q1") & key=="PIB") 
```


## Représenter des séries temporelles: chronogramme

- Chronogramme: diagramme des points (x=date, y=valeur de l'observation)
- Pour un objet de la classe `ts` on peut utiliser la méthode générique `plot()`
```{r sunspot, echo=FALSE, out.width="70%", fig.align="center"}
plot(pib_ts[,c("PIB", "P7")],xlab="Trimestre",ylab="PIB", main="Données PIB")
```


## Chronogramme - Série univariée - PIB

```{r , out.width="70%", fig.align="center", warning=FALSE}
pib_tsbl %>% filter(key=="PIB") %>%
  ggplot(aes(x = index, y = value))+
    geom_line(color = "#00AFBB", size = 1)
```

## Chronogramme - PIB - Echelle logarithmique

```{r , out.width="70%", fig.align="center", warning=FALSE}
pib_tsbl %>% filter(key=="PIB") %>%
  ggplot(aes(x = index, y = log(value))) +
    geom_line(color = "#00AFBB", size = 1)
```

## Chronogramme - Données `pib` - Série multivariée

```{r, warnings=F, message=FALSE, out.width="70%", fig.align="center"}
pib_tsbl %>%
  filter(key %in% c("PIB", "P3M", "P7","P54")) %>%
  ggplot(aes(x = index, y = value)) + 
    geom_line(aes(color = key), size = 1) +
    scale_color_manual(values = c("red", "blue", "green","yellow"))
```


## Fonction d'autocorrélation - Données `pib`

- On peut représenter simplement la fonction d'autocorrélation obtenue avec la fonction `ACF()`
```{r, warnings=F, message=FALSE, out.width="70%", fig.align='center'}
library(feasts)
pib_tsbl %>% filter(key=="PIB") %>% 
  ACF(value) %>% autoplot() + theme_minimal()
```


## Désaisonnalisation avec la régression linéaire:

Source: [dumortier](https://jrfdumortier.github.io/dataanalysis/trend-and-seasonality.html)

- On peut également utiliser la fonction `tslm` de la librairie `forecast` 
- Cette fonction ajuste un modèle linéaire incluant la saisonalité et la tendance (et éventuellement la tendance au carré).

```{r}
library(forecast)
bhat = tslm(pib_ts[,'PIB']~trend+I(trend^2)+season)
summary(bhat)
```


## Manipulation des objets `ts`: extraction de l'index

- Extraction de l'index

```{r pib_ts_time, echo=TRUE}
pib2021p <- window(pib_ts, start=2020)
time(pib2021p)
```

- Conversion de l'index au format numérique
```{r pib_ts_time2, echo=TRUE}
library(lubridate)
as.numeric(time(pib2021p))
```


## Simulez un bruit blanc Gausssien

```{r}
bbg <- ts(rnorm(1000, mean=0, sd=3))
window(bbg, start=1, end=10)
```

```{r, out.width="70%", fig.align="center"}
library(ggfortify)
autoplot(bbg)+ 
  ggtitle("White Noise")
```

## Simulez une marche aléatoire

```{r}
tmax <- 100
wnoise <- rnorm(99, mean=0, sd=0.41)
y <- rep(0,tmax)
y[1] = 1.39

for (t in 2:tmax) {
  y[t] = y[t-1] + wnoise[t-1] 
}
rw <- tibble(time=1:tmax, y=y)
rw
```

```{r, out.width="70%", fig.align="center"}
ggplot(rw) + geom_line(aes(x=time, y=y), colour="blue")
```


## Fonction d'autocorrélation

```{r}
acf(rw["y"])
```


## Test de Portmanteau

```{r}
box_pierce(rw["y"])
```


# Représentez la série du PIB

# Chronogramme

```{r}
pib_tsbl %>%
  ggplot(aes(x = index, y = value)) + 
    geom_line(aes(color = key), size = 1)
```
```{r}
pib_tsbl %>% filter(key=="P54") %>%
  ggplot(aes(x = index, y = value)) + 
    geom_line(aes(color = key), size = 1)


```


## Season plot

```{r}
pib_tsbl %>% filter(key=="PIB" & index>yearquarter("2000 Q1")) %>% gg_season()
```
```{r}
pib_tsbl %>% filter(key=="PIB" & index>yearquarter("2000 Q1")) %>% gg_lag()
```
```{r}
pib_tsbl %>% filter(key=="PIB") %>% ACF() %>% autoplot()
```
```{r}
pib_tsbl %>% filter(key=="P54") %>% ACF() %>% autoplot()
```
```{r}
pib_tsbl %>% filter(key=="P54" & index>yearquarter("2000 Q1")) %>% gg_lag(lags=12)
```
